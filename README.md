#Important#

Transloadit .NET SDK works with .NET 3.5 or with later version.

#Purpose#

This is the official .NET SDK for the transloadit.com API.

You can use it to setup file upload forms for your users, or to upload existing files from your server.

Transloadit SDK for .NET allows you to use Transloadit services easily with .NET applications (Web applications, desktop applications, windows phone applications)

#Directory structure#

- "build" - it is in .gitignore (directory will be created automatically when the class libraries are built)
- "lib" - Whole source of the SDK
- "test" - Source of unit tests

#Examples#

Transloadit .NET SDK is easy to configure, easy to use, easy to develop and easy to extend. Please see the details below.

##Used configuration##

Necessary sections must be existing in your application config file. Please see details below.

```xml
<?xml version="1.0"?>
<configuration>
  <configSections>
      <section
        name="transloadit"
        type="Transloadit.Config.TransloaditConfigSection, Transloadit"
        allowLocation="true"
        allowDefinition="Everywhere"
      />
  </configSections>
  <transloadit>
    <transloadit-configs>
      <add name="default" 
           auth-key="YOUR-API-KEY" 
           auth-secret="YOUR-SECRET-KEY" 
           auth-expire="120" 
           use-bored-instance="true"
           default-template-id="YOUR-TEMPLATE-ID" />
    </transloadit-configs>
	<log type="YourLogger.LoggerForTransloadit, YourLogger" enabled="true" />
  </transloadit>
</configuration>
```

##Sample application##

The sample application below is the part of a simple console application. You can use that example in each kind of application (desktop applications, web applications, mobile applications).

###1. Upload file, use pre-created template with all required settings###

```C#
using System;
using System.Collections.Generic;
using System.Text;
using System.Configuration;
using System.Collections.Specialized;

using Transloadit;
using Transloadit.Assembly;
using Transloadit.Log;

namespace TestConsole
{
	class Program
	{
		static void Main(string[] args)
		{
			//Create Transloadit instance
			ITransloadit transloadit = new Transloadit.Transloadit();
			
			//Set template ID
			transloadit.SetTemplateID("YOUR-PRECREATED-TEMPLATE-ID");
			
			//Create assembly builder to build up the assembly
			IAssemblyBuilder assembly = new AssemblyBuilder();

			//Add a file to be uploaded with autogenerated key
			assembly.AddFile(@"C:\temp\test.jpg");
           
			//Invoke assembly, and wait for the result
			TransloaditResponse response = transloadit.InvokeAssembly(assembly);
			
			if (response.Success)
			{
				LoggerFactory.GetLogger().LogInfo(Type.GetType("TestConsole.Program"), "Assembly {0} result", response.Data["assembly_id"]);
			}
			else
			{
				LoggerFactory.GetLogger().LogError(Type.GetType("TestConsole.Program"), "Error has occured while completing assembly");
			}
			Console.ReadLine();
		}
	}
}
```

###2. Upload file, with custom assembly with all required also with optional settings###

```C#
using System;
using System.Collections.Generic;
using System.Text;
using System.Configuration;
using System.Collections.Specialized;

using Transloadit;
using Transloadit.Assembly;
using Transloadit.Log;

namespace TestConsole
{
	class Program
	{
		static void Main(string[] args)
		{
			//Create Transloadit instance
			ITransloadit transloadit = new Transloadit.Transloadit();
				
			//Create assembly builder to build up the assembly
			IAssemblyBuilder assembly = new AssemblyBuilder();

			//Add a file to be uploaded with autogenerated key
			assembly.AddFile(@"C:\temp\test_1.jpg");
			
			//Add a file to be uploaded with custom key
			assembly.AddFile("custom_file", @"C:\temp\test_2.jpg");
			
			//Define the step, you can define more in the same assembly
			IStep step = new Step();
			step.SetOption("robot", "/image/resize");
			step.SetOption("width", 75);
			step.SetOption("height", 75);
			step.SetOption("resize_strategy", "pad");
			step.SetOption("background", "#000000");
			
			//Add the step to the assembly
			assembly.AddStep("thumb", step);
			
			//Set notification URL
			assembly.SetNotifyURL("http://your-service.net/ready"); 
			
			//Set your public API Key 
			assembly.SetAuthKey("YOUR-API-KEY");
			
			//Set the expiration date time of the request for the assembly
			//Assembly will be expired in 120 minutes from now
			assembly.SetAuthExpire(Date.Now.AddMinutes(120));
			
			//Invoke assembly, and wait for the result
			TransloaditResponse response = transloadit.InvokeAssembly(assembly);
			
			if (response.Success)
			{
				LoggerFactory.GetLogger().LogInfo(Type.GetType("TestConsole.Program"), "Assembly {0} result", response.Data["assembly_id"]);
			}
			else
			{
				LoggerFactory.GetLogger().LogError(Type.GetType("TestConsole.Program"), "Error has occured while completing assembly");
			}
            Console.ReadLine();
		}
	}
}
```

#Transloadit .NET API#

You need to download the necessary assembly and integrate it to your application. Also you can pull the source and compile with your application.

##1. Configuration##

In your application configuration file you need to add some configuration nodes for Transloadit. Please see the required also the optional configurations below.

```xml
<?xml version="1.0"?>
<configuration>
  <configSections>
      <section
        name="transloadit"
        type="Transloadit.Config.TransloaditConfigSection, Transloadit"
        allowLocation="true"
        allowDefinition="Everywhere"
      />
  </configSections>
  <transloadit>
    <transloadit-configs>
      <add name="default" 
           auth-key="YOUR-API-KEY" 
           auth-secret="YOUR-SECRET-KEY" 
           auth-expire="120" 
           use-bored-instance="true"
           default-template-id="YOUR-TEMPLATE-ID" />
    </transloadit-configs>
	<log type="YourLogger.LoggerForTransloadit, YourLogger" enabled="true" />
  </transloadit>
</configuration>
```

###1.1. Add Transloadit configuration handler to the app.config (web.config)###

In the `<configurationSections>` you need to define the class, which will handle the set values in the custom `<transloadit>` section. As you can see in the XML above Transloadit config is parsed by `Transloadit.Config.TransloaditConfigSection` class, which locates in the `Transloadit` assembly.

####1.1.1. Use of `<transloadit>` section####

In the `<transloadit>` section you can define more config values for Transloadit, even if you would like to use more then one. It can be useful if you would like to host your service with more Transloadit account for example.

####1.1.2. Use `<transloadit-configs>` section####

Transloadit configs, which will be used in your application.

####1.1.3. Use of `<add />` node####

With this element you are able to define a Transloadit config element. You can set attributes for authentication also for other processing.

- `name` - required unique name of the config element, you can refer to that in the `Translodit.Transloadit` constructor; if config name is not defined, then the one which has the "default" name will be used;if you would not like to use config names in your application, or you would like to use only one Transloadit config, then it's preferred to create an element with name "default"
- `auth-key` - your public Transloadit API key (optional in the config, but required for Transloadit, able to be set in the source code)
- `auth-secret` - your private Transloadit SECRET key (optional in the config, but required for Transloadit, also able to be set in the source code)
- `auth-expire` - definition of request lifetime in minutes of each Transloadit request (optional, also able to be set in the source code, default value is `120`)
- `use-bored-instance` - valid values are `true` or `false`; Transloadit can use bored instances to give result in shorter time; you can enable or disable this functionality (optional, also able to be set in the source code, default value is `true`)
- `default-template-id` - your template ID which will be used in the current config (optional, also able to be set in the source code)

####1.1.4. Use of `<log />` element####

Transloadit .NET SDK allows you to log info or errors while using the service. You can use the default logger (logs everything to the `Console`), or 
you can define a custom one, which implements `ITransloaditLogger` interface. Also you can disable or enable the logging, while setting the `enabled` attribute to `true` or `false`.

- `type` - required attribute, defines the whole logger class (logger object is provided by `Transloadit.Log.LoggerFactory.GetLogger()` method)
- `enabled` - optional attribute to enable or disable logging, `false` as default

###1.2. Possible problems because of wrong authentication config values###

####1.2.1. Non-existing config####

`Transloadit.Config.Exceptions.ConfigNotFoundException` will be thrown if the required Transloadit config element is not existing, or the required settings in the application config file are not set.

####1.2.2. Wrong authentication keys####

Public API key and private SECRET key cannot be validated while parsing the config values. If one, or both of them are wrong, then bad request will be handled by the SDK.

####1.2.3. Wrong expiration value####

If the set expiration cannot be parsed as a double value, then the default one (`120`) will be used.

###1.3. Possible problems because of wrong log config values###

If `<log />` element is not defined in the application configuration file, then there will be no Transloadit log used. If the element is defined, but the `type` attribute is missing then `Transloadit.Log.Exceptions.UndefinedLoggerClassException` exception will be thrown. If logger type is defined, but it's not existing in the context of the application, then `Transloadit.Log.Exceptions.LoggerClassNotFoundException` will be thrown.

> **Note:**
> Do not forget to set the `enabled` attribute so set to `true` to make the log work

##2. Use of the SDK##

If you would like to use .NET SDK for Transloadit in your application, you need to add it as a reference, or you need to pull the latest commit, and use the source directly.

Transloadit services work with assemblies. An assembly must contain each information which will be used for authentication and processing. Each assembly must contain authentication information, steps or template ID. You can set custom, and optional values like custom fields and files too.

> **Note:** template ID is the ID of a Transloadit templates that can be defined on Transloadit admin surface

###2.1. Use configuration values###

Transloadit configuration is handled by the set class. All the information is stored in the `Transloadit.Config.TransloaditConfig` static class. Config values canbe accessed via the static `Config` property (`Transloadit.Config.TransloaditConfig.Config`).

###2.2. Use of `Transloadit.Transloadit` class###

By that class you are able to create a Transloadit instance, which will process all the assemblies sent by your application.

`ITransloadit transloadit = new Transloadit();`

> **Note:** You can use Transloadit instance as singleton instance.

###2.3. Build an assembly###

To build up an assembly you need to use `Transloadit.Assembly.AssemblyBuilder`.

`IAssemblyBuilder builder = new AssemblyBuilder;`

As described above, you can define steps for your assembly, you can use `Transloadit.Assembly.Step` class to do that. Each step must have option(s), can be set by `SetOption(string key, object value)` method. That step will be proceed on your uploaded, or predefined resources.

```C#
//Step below will resize the uploaded image to 75x75 size
//with pad resize strategy also with #000000 background color

IStep step = new Step();
step.SetOption("robot", "/image/resize");
step.SetOption("width", 75);
step.SetOption("height", 75);
step.SetOption("resize_strategy", "pad");
step.SetOption("background", "#000000");
```

To add that step to your assembly you need to call the `AddStep(string name, IStep step)` method, where the `name` parameter is the key of the step. You can refer to that in further steps in the same assmebly, even if you add more.

`builder.AddStep("resize", step);`

####2.3.1. Add custom field to the assembly####

Custom fields can be set for each assembly as a parameter of a precreated template. You can set custom fields with `SetField(string key, object value)` method, where the `key` parameter is the unique key of the field and `value` parameter is the value of the field.

If a valid key is not defined in the custom field collection, then it will be created, also the related value will be set. If a valid key is already defined then it will be overriden with the passed value.

There are some field keys which are used by the SDK. You are not able to use these keys as custom field keys such as "notify_url", "params", "signature", "template_id". If you try to use one of those keys, then a `Transloadit.Assembly.Exceptions.InvalidKeyFieldKeyException` will be thrown.

`Transloadit.Assembly.Exceptions.AlreadyDefinedFieldKeyException` will be thrown, if you try to use a custom field key, which is already defined as a key of a file (read about files in the next section below).

`builder.SetField("field_key", "field_value")`

####2.3.2. Add file to the assembly####

You can call `AddFile(string path)` or `AddFile(string key, string path)` method, where the `key` parameter is the unique key of the file and the `path` parameter is the absolute or relative path of the file, on the created `builder` object to add a file to your assembly. 

If you call the method with only the `path` parameter, then the key of the file will be an autogenerated key. If you call the method with both parameters, then the file will be added by the specified key. If the key is already defined as a custom field key or a file key, then an autogenerated key will be set for the file.

`builder.AddFile(@"c:\temp\test.jpg")` or `builder.AddFile("custom_file", @"c:\temp\test.jpg")`

####2.3.3. Set authentication information####

As described above, you can set manually authentication information. Some methods give you the possibility to do that, please see examples below. Methods can be called on the `builder` object.

- `SetAuthKey(string key)` - sets your public API key
- `SetAuthExpires(DateTime date)` - sets the request expiration date
- `SetAuthMaxSize(int size)` - sets the max size (in bytes) of the requests 

```C#
builder.SetAuthKey("YOUR-API-KEY");
builder.SetAuthExpires(DateTime.Now.AddMinutes(120)); //Request will be expired after the current date time + 120 minutes
builder.SetAuthMaxSize(1024);
```

> **Note:** These methods are optional

####2.3.4. Set notify URL####

You can define notify URL for your assembly by calling `SetNotifyURL(string notifyURL)` on the `builder` object, which will be requested after the assembly is done on Transloadit server.

`builder.SetNotifyURL("http://your-service.net/ready");`

If your assembly is done, then a POST request will be sent to the specified notify URL. By that request you will get information about the status of the created assembly by the posted `transloadit` field.
If the Transloadit has sent `assembly_url` as a GET parameter, then that URL will be called by a TransloaditRequest.

> **For example:** You have a mobile .NET application, which invokes assemblies via that .NET SDK, and you have a REST API service written in PHP, which can handle the request which will be sent after the assembly is done. What you need to do is to integrate PHP Transloadit SDK to your PHP REST API service and call `Transloadit::response()` method, then you will be able to use the result of the assembly in your service (like creating database records, or do something).

####2.3.5. Set template ID####

You can define the template ID which will be used to proceed your assembly on Transloadit server. You can use `SetTemplateID(string templateID)` for that, where the `templateID` parameter is the ID of the precreated template.

`builder.SetTemplateID("ID-OF-PRECEREATED-TEMPLATE");`

####2.3.6. Create assembly on Transloadit####

After your assembly is built up you can send it to Transloadit server by `InvokeAssembly(IAssmeblyBuilder builder)` method, where the `builder` parameter is the built up instance of `AssemblyBuilder` class, that can be called on `transloadit` object. The result of the assembly will be represented in an `ITransloaditJsonResponse` implementation.

`ITransloaditJsonResponse response = transloadit.InvokeAssembly(builder);`

After the request is done and `response` object was created, you are able to use it to handle the result by some `response` object properties, please see them below.

- `response.Data` - gets the response as a dictionary (`Dictionary<string, object>`)
- `response.ResponseString` - gets the response string
- `response.ResponseQuality` - gets the quality of the response as a TransloaditResponse.Quality enum
- `response.Success` - gets the success of the request

> **Note:** `response.Data` main dictionary can store sub dictionaries as the value of the main dictionary

####2.3.7. Delete assembly on Transloadit####

Transloadit .NET SDK gives you the possibility to delete an assembly on the server. You can call `DeleteAssembly(string assemblyID)` method, where `assemblyID` parameter is the ID of an exisiting assembly, on the created `transloadit` object. That call can be useful, when you would like to cancel your assembly invoke process.

´ITransloaditJsonResponse response = transloadit.DeleteAssembly("YOUR-CREATED-ASSEMBLY-ID");´

You can handle the response like in case of invoke an assembly.

###2.4. Use of Transloadit logger###

As described above the SDK provides you the possibility to log information and errors. You can use the default `Transloadit.Log.TransloaditLogger`, also you can implement the `Transloadit.Log.ITransloaditLogger` interface to create a custom one.

Logger object can be accessed by the `Transloadit.Log.LoggerFactory.GetLogger()` method. That static factory will get the singleton `Transloadit.Log.ITransloaditLogger` implementation. The returned type can be set in the application configuration (see the description above). One method provides the possibility to log info, also some other methods provides the possibility to log errors, please see the examples below.

- `LogInfo(Type type, string message, params object[] parameters)` - logs information, where the `type` is the type of the sender object, `message` is the custom log message with parameters and `parameters` are the parameters of the custom log message 
- `LogError(Type type, Exception exception, string message, params object[] parameters)` - logs error (preferred to use in case of an exception thrown), where the `type` is the type of the sender object, `exception` is the thrown exception, `message` is the custom log message with parameters and `parameters` are the parameters of the custom log message

> **Note: ** `LogError(...)` method has more parameter definition

##3. Extend Transloadit .NET API##

The SDK is able to be extended. You can use the interfaces to create own implementation, also you can extend the precreated classes to have an extended SDK. Transloadit logger is preferred to be extended.

###3.1. Extend Transloadit logger###

You need to create a class, which implements `Transloadit.Log.ITransloaditLogger` inerface. After you have a working implementation, you can set it in the application configuration.

`<log type="YourLogger.LoggerForTransloadit, YourLogger" enabled="true" />`

The `type` attribute of the log element represents the whole definition of your custom logger, where `YourLogger.LoggerForTransloadit` is the exact definition of the logger class and comma separated `YourLogger` is the name of the assembly, which stores your custom logger. `YourLogger.LoggerForTransloadit` must implement `Transloadit.Log.ITransloaditLogger` interface.

##4. Run unit tests##

To pass all unit tests you need NUnit to be installed on your machine. Compile the test project, then use "Tests.dll" to test.

> **Note: ** You need a config file for unit testing too, which should have been configured by your own. The skeleton of it is attached to the project (Tests.dll.config). Please update it with your keys, don't update the "name" attribute of the config elements.

> **Note: ** You need to compile the "Tests" project.